<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام تسجيل الحضور</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      direction: rtl;
      text-align: right;
      margin: 0;
      padding: 0;
      background-color: #f4f7fb;
      color: #4a4a4a;
    }
    .container {
      background: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 100%;
      box-sizing: border-box;
      margin: 20px auto;
      font-size: 16px;
      border: 1px solid #dde1e7;
    }
    h2 {
      color: #2a4d6d;
      font-size: 24px;
      margin-bottom: 20px;
    }
    label {
      font-size: 18px;
      font-weight: bold;
      color: #3e4751;
    }
    select, input, button {
      margin: 10px 0;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ced4da;
      outline: none;
      transition: background-color 0.3s, box-shadow 0.3s;
      background-color: #fafbfc;
    }
    select:focus, input:focus, button:focus {
      border-color: #6c8ed4;
      box-shadow: 0 0 0 0.25rem rgba(108,142,212,0.5);
    }
    .attendance-btns button {
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 16px;
      transition: background-color 0.3s, opacity 0.3s;
      cursor: pointer;
    }
    .present-btn.selected {
      background-color: #28a745;
    }
    .absent-btn.selected {
      background-color: #dc3545;
    }
    .excused-btn.selected {
      background-color: #ffc107;
    }
    .unset-btn.selected {
      background-color: white;
      color: black;
    }
    .bonus-btn {
      background-color: #e0e0e0;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 16px;
    }
    .bonus-btn.golden {
      background-color: gold;
      color: #000;
    }
    .reset-btn {
      background-color: #ffc107;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s, opacity 0.3s;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #dde1e7;
      padding: 12px;
      text-align: center;
      font-size: 16px;
      background-color: #f8f9fa;
    }
    th {
      background-color: #e8eef3;
      color: #2a4d6d;
    }
    .attendance-btns, .bonus-container {
      display: flex;
      justify-content: center;
      gap: 5px;
    }
    .selected {
      opacity: 0.9;
      font-weight: bold;
    }
    footer {
      text-align: center;
      padding: 15px;
      font-size: 14px;
      color: #888;
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      table {
        font-size: 14px;
      }
      h2 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <h2>نظام تسجيل الحضور</h2>
    <p>📅 التاريخ: <span id="currentDate"></span></p>
    <label for="subject">📚 اختر المادة:</label>
    <select id="subject">
      <option>Advanced Cryptography</option>
      <option>Arabic</option>
      <option>Database Security</option>
      <option>Data Structures and Algorithms</option>
      <option>Internet Protocols</option>
      <option>Operating Systems</option>
      <option>Web Programming Security</option>
    </select>
    <br>
    <label for="sectionSelect">🏫 اختر الشعبة:</label>
    <select id="sectionSelect">
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
      <option value="E">E</option>
      <option value="F">F</option>
      <option value="G">G</option>
      <option value="H">H</option>
      <option value="I">I</option>
      <option value="J">J</option>
    </select>
    <p>
      👥 العدد الكلي: <span id="totalCount">0</span> | 
      ✅ الحضور: <span id="presentCount">0</span> | 
      ❌ الغياب: <span id="absentCount">0</span> | 
      ⚠️ المجاز: <span id="excusedCount">0</span>
    </p>
    <table id="attendanceTable" role="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>الاسم</th>
          <th>الحضور / الغياب / المجاز</th>
          <th>بلس+</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody"></tbody>
    </table>
    <button class="reset-btn" id="resetAttendanceBtn">🔄 إعادة ضبط</button>
    <button id="downloadExcelBtn">📥 تحميل Excel</button>
  </main>
  <footer>حقوق التصميم © جميع الحقوق محفوظة</footer>
  <script>
    // عرض التاريخ الحالي
    document.getElementById("currentDate").textContent = new Date().toLocaleDateString("ar-EG");

    // بيانات الطلاب لشعبة A (أسماء شعبية)
    var studentsSectionA = [
      "ابراهيم داود سلمان حنون",
      "ابراهيم عدنان كاظم جاسم",
      "احمد جعفر صالح محمود",
      "احمد شاكر جعفر عذيب",
      "احمد عامر جواد كاظم",
      "احمد عامر طاهر حسون",
      "احمد عباس حسين جمعه",
      "احمد عباس عواد جابر",
      "احمد عباس كاظم حمدان مسائي",
      "احمد عبد المنعم عبد الحميد راشد",
      "احمد عدي ياس خضير",
      "احمد علي جمعه علي",
      "احمد علي شذر زايد",
      "احمد فراس خضير حسين",
      "احمد فرحان خلف هويدي",
      "احمد مهند احمد محمد",
      "احمد موفق صاحب داود",
      "اريفان فرهاد طاهر كاكه خان",
      "اسامة حسن ضاري انغيمش",
      "اسامه نهاد محسن احمد",
      "الأمير علي محيسن خلف",
      "الحسن فاضل حسين سرحان",
      "الحمزه قاسم علي صحن",
      "المرتضى مالك محسن عبد السادة",
      "امنه عبد الصمد ذنون احمد",
      "امنه عبد الصمد ذنون احمد",
      "امير حسنين هاشم محمد",
      "امير عبد الرحمن مزعل حسين",
      "امير قاسم سوادي محمد",
      "اميمة سعد عبد المطلب خلف",
      "اواب حمزة عباس",
      "اوس محمد حميد احمد",
      "بارق رعد فاضل حسين",
      "جاسم محمد حسين شيال",
      "حسن عباس علي حسين",
      "حسين فتح الله حسب الله حمود",
      "رسول صميم كريدي عنفوص",
      "روان علي عادل عبد الوهاب",
      "زهراء محمد بدر جدوع",
      "زين العابدين علاوي عبد الحسين",
      "سبأ وليد محمد مسائي",
      "سجى محمد حميد عباس مسائي",
      "ضحى عبد الله حسن علي",
      "عباس وليد خالد نشعان",
      "قتادة شاكر جعفر عذيب",
      "محمد جواد رشيد ياسر كزار",
      "محمد حسام محمد عبد الله",
      "محمد هاشم محمد شمس الدين",
      "مرتضى رياض حسن علوان مسائي",
      "مصطفى صلاح الدين ابراهيم جاسم",
      "ميس وسام عبد الله مهدي",
      "ياسر عمار بدري صبري",
      "ياسين حيدر حمزة محمد حسين"
    ];
    // (يتم تعريف بيانات باقي الأقسام بنفس الطريقة...)
    var studentsSectionB = [ /* ... */ ];
    var studentsSectionC = [ /* ... */ ];
    var studentsSectionD = [ /* ... */ ];
    var studentsSectionE = [ /* ... */ ];
    var studentsSectionF = [ /* ... */ ];
    var studentsSectionG = [ /* ... */ ];
    var studentsSectionH = [ /* ... */ ];
    var studentsSectionI = [ /* ... */ ];
    var studentsSectionJ = [ /* ... */ ];

    var sections = {
      "A": studentsSectionA,
      "B": studentsSectionB,
      "C": studentsSectionC,
      "D": studentsSectionD,
      "E": studentsSectionE,
      "F": studentsSectionF,
      "G": studentsSectionG,
      "H": studentsSectionH,
      "I": studentsSectionI,
      "J": studentsSectionJ
    };

    var currentSection = document.getElementById("sectionSelect").value;
    var students = sections[currentSection];
    var attendanceData = getAttendanceData();
    var bonusData = getBonusData();

    function getAttendanceData() {
      var key = 'attendanceData_' + currentSection;
      try {
        var data = JSON.parse(localStorage.getItem(key));
        if (Array.isArray(data) && data.length === students.length) return data;
      } catch(e){}
      return new Array(students.length).fill(null);
    }
    function setAttendanceData(data) {
      var key = 'attendanceData_' + currentSection;
      try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){}
    }

    function getBonusData() {
      var key = 'bonusData_' + currentSection;
      try {
        var data = JSON.parse(localStorage.getItem(key));
        if (Array.isArray(data) && data.length === students.length) return data;
      } catch(e){}
      return new Array(students.length).fill(null);
    }
    function setBonusData(data) {
      var key = 'bonusData_' + currentSection;
      try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){}
    }

    function renderTable() {
      var tableBody = document.getElementById("studentsTableBody");
      tableBody.innerHTML = "";
      students.forEach(function(student, index) {
        var row = document.createElement("tr");

        // رقم الطالب والاسم
        var idCell = document.createElement("td");
        idCell.textContent = index + 1;
        var nameCell = document.createElement("td");
        nameCell.textContent = student;

        // خلية الحضور/الغياب/المجاز
        var attendanceCell = document.createElement("td");
        var btnContainer = document.createElement("div");
        btnContainer.classList.add("attendance-btns");

        // زر الحضور
        var presentBtn = document.createElement("button");
        presentBtn.classList.add("present-btn");
        if (attendanceData[index] === "present") presentBtn.classList.add("selected");
        presentBtn.textContent = "✅ حضور";
        presentBtn.setAttribute("data-index", index);
        presentBtn.setAttribute("data-status", "present");
        btnContainer.appendChild(presentBtn);

        // زر الغياب
        var absentBtn = document.createElement("button");
        absentBtn.classList.add("absent-btn");
        if (attendanceData[index] === "absent") absentBtn.classList.add("selected");
        absentBtn.textContent = "❌ غياب";
        absentBtn.setAttribute("data-index", index);
        absentBtn.setAttribute("data-status", "absent");
        btnContainer.appendChild(absentBtn);

        // زر المجاز
        var excusedBtn = document.createElement("button");
        excusedBtn.classList.add("excused-btn");
        if (attendanceData[index] === "مجاز") excusedBtn.classList.add("selected");
        excusedBtn.textContent = "⚠️ مجاز";
        excusedBtn.setAttribute("data-index", index);
        excusedBtn.setAttribute("data-status", "مجاز");
        btnContainer.appendChild(excusedBtn);

        // زر إلغاء التحديد
        var unsetBtn = document.createElement("button");
        unsetBtn.classList.add("unset-btn");
        if (attendanceData[index] === null) unsetBtn.classList.add("selected");
        unsetBtn.textContent = "❔ إلغاء التحديد";
        unsetBtn.setAttribute("data-index", index);
        unsetBtn.setAttribute("data-status", "unset");
        btnContainer.appendChild(unsetBtn);

        attendanceCell.appendChild(btnContainer);

        // خلية البلس+
        var bonusCell = document.createElement("td");
        var bonusContainer = document.createElement("div");
        bonusContainer.classList.add("bonus-container");

        var bonusBtn = document.createElement("button");
        bonusBtn.classList.add("bonus-btn");
        if (!bonusData[index]) {
          bonusBtn.textContent = "بلس+";
          bonusBtn.classList.add("golden");
        } else {
          bonusBtn.textContent = bonusData[index];
          bonusBtn.classList.remove("golden");
        }
        bonusBtn.setAttribute("data-index", index);
        bonusBtn.addEventListener("click", function() {
          var sel = document.createElement("select");
          sel.style.fontSize = "16px";
          sel.setAttribute("data-index", index);
          var emptyOpt = document.createElement("option");
          emptyOpt.value = "";
          emptyOpt.textContent = "-----";
          sel.appendChild(emptyOpt);
          for (var i = 1; i <= 5; i++) {
            var opt = document.createElement("option");
            opt.value = i;
            opt.textContent = i;
            sel.appendChild(opt);
          }
          sel.addEventListener("change", function() {
            var idx = sel.getAttribute("data-index");
            bonusData[idx] = sel.value ? sel.value : null;
            setBonusData(bonusData);
            bonusContainer.removeChild(sel);
            bonusBtn.textContent = bonusData[idx] ? bonusData[idx] : "بلس+";
            if (!bonusData[idx]) {
              bonusBtn.classList.add("golden");
            } else {
              bonusBtn.classList.remove("golden");
            }
            bonusContainer.appendChild(bonusBtn);
          });
          bonusContainer.removeChild(bonusBtn);
          bonusContainer.appendChild(sel);
          sel.focus();
        });
        bonusContainer.appendChild(bonusBtn);
        bonusCell.appendChild(bonusContainer);

        row.appendChild(idCell);
        row.appendChild(nameCell);
        row.appendChild(attendanceCell);
        row.appendChild(bonusCell);
        tableBody.appendChild(row);
      });
      updateCounts();
    }

    // تعديل حساب الغياب ليُحسب عدد الطلاب الذين لم يسجل لهم "حضور" أو "مجاز"
    function updateCounts() {
      var totalCount = students.length;
      var presentCount = attendanceData.filter(function(s) { return s === "present"; }).length;
      var excusedCount = attendanceData.filter(function(s) { return s === "مجاز"; }).length;
      // الطلاب الذين قيمتهم null أو "absent" يُعتبرون غائبين
      var absentCount = attendanceData.filter(function(s) { return s === null || s === "absent"; }).length;
      document.getElementById("totalCount").textContent = totalCount;
      document.getElementById("presentCount").textContent = presentCount;
      document.getElementById("absentCount").textContent = absentCount;
      document.getElementById("excusedCount").textContent = excusedCount;
    }

    document.getElementById("studentsTableBody").addEventListener("click", function(e) {
      if (e.target.tagName.toLowerCase() === "button" && e.target.hasAttribute("data-status")) {
        var index = e.target.getAttribute("data-index");
        var status = e.target.getAttribute("data-status");
        attendanceData[index] = (status === "unset") ? null : status;
        setAttendanceData(attendanceData);
        renderTable();
      }
    });

    document.getElementById("resetAttendanceBtn").addEventListener("click", function() {
      attendanceData = new Array(students.length).fill(null);
      bonusData = new Array(students.length).fill(null);
      setAttendanceData(attendanceData);
      setBonusData(bonusData);
      renderTable();
    });

    document.getElementById("downloadExcelBtn").addEventListener("click", function() {
      downloadExcel();
    });

    function downloadExcel() {
      var subject = document.getElementById("subject").value;
      var section = document.getElementById("sectionSelect").value;
      var date = new Date().toLocaleDateString("en-GB");
      var totalCount = students.length;
      var presentCount = attendanceData.filter(function(s) { return s === "present"; }).length;
      var excusedCount = attendanceData.filter(function(s) { return s === "مجاز"; }).length;
      var absentCount = attendanceData.filter(function(s) { return s === null || s === "absent"; }).length;
      var wb = XLSX.utils.book_new();
      var headerInfo = [
        ["تاريخ اليوم:", date],
        ["المادة:", subject],
        ["الشعبة:", section],
        ["العدد الكلي:", totalCount, "الحضور:", presentCount, "الغياب:", absentCount, "المجاز:", excusedCount],
        [],
        ["ID", "الاسم", "الحالة", "بلس+"]
      ];
      students.forEach(function(student, index) {
        var attAbbr = "";
        if(attendanceData[index] === "present") attAbbr = "ح";
        else if(attendanceData[index] === "absent") attAbbr = "غ";
        else if(attendanceData[index] === "مجاز") attAbbr = "م";
        headerInfo.push([
          index + 1,
          student,
          attAbbr,
          bonusData[index] ? bonusData[index] : ""
        ]);
      });
      var ws = XLSX.utils.aoa_to_sheet(headerInfo);
      ws["!cols"] = [{ wch: 7 }, { wch: 25 }, { wch: 10 }, { wch: 8 }];
      ["A1","B1","A2","B2","A3","B3"].forEach(function(cell) {
        if(ws[cell]) ws[cell].s = { font: { sz: 16 } };
      });
      if(ws["B6"]) ws["B6"].s = { font: { sz: 16 } };
      for(var i=0;i<students.length;i++){
        var cellAddress = "B" + (7+i);
        if(ws[cellAddress]) ws[cellAddress].s = { font: { sz: 16 } };
      }
      XLSX.utils.book_append_sheet(wb, ws, "الحضور");
      var fileName = section + "_" + date.replace(/\//g, "-") + ".xlsx";
      XLSX.writeFile(wb, fileName, { cellStyles: true });
    }

    function updateStudentsList() {
      currentSection = document.getElementById("sectionSelect").value;
      students = sections[currentSection];
      attendanceData = getAttendanceData();
      bonusData = getBonusData();
      renderTable();
    }
    document.getElementById("sectionSelect").addEventListener("change", updateStudentsList);
    renderTable();
  </script>
</body>
</html>
